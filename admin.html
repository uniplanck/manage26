<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proç®¡ç†ç”»é¢</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
  body { font-family: 'Noto Sans JP', sans-serif; padding: 15px; background: #f1f5f9; color: #334155; margin: 0; }
  .container { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
  .card { background: #fff; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
  
  h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 25px; color: #0f172a; }
  h3 { font-size: 1rem; margin-bottom: 15px; color: #64748b; }
  
  /* Login Screen */
  #login-panel { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; }
  .login-card { width: 100%; max-width: 400px; text-align: center; }
  
  .input-group { margin-bottom: 15px; text-align: left; }
  .input-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #64748b; }
  .input-group input, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
  
  .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; color: #fff; margin-bottom: 10px; }
  .btn-primary { background: #2563eb; }
  .btn-primary:hover { background: #1d4ed8; }
  .btn-google { background: #fff; color: #333; border: 1px solid #cbd5e1; display: flex; align-items: center; justify-content: center; gap: 10px; }
  .btn-google:hover { background: #f8fafc; }
  .btn-remove { background: #ef4444; padding: 6px 12px; font-size: 0.8rem; width: auto; color: #fff; border-radius: 4px; }
  .btn-edit { background: #0f172a; padding: 6px 12px; font-size: 0.8rem; width: auto; color: #fff; border-radius: 4px; }
  .btn-cancel { background: #64748b; padding: 6px 12px; font-size: 0.8rem; width: auto; color: #fff; border-radius: 4px; }

  #admin-panel { display: none; }
  .form-grid { display: grid; gap: 15px; grid-template-columns: 1fr; }
  @media (min-width: 600px) { .form-grid { grid-template-columns: 1fr 1fr; } }
  
  .history-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }

  /* Review List */
  .review-list { list-style: none; padding: 0; margin-top: 20px; }
  .review-item { 
    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; 
    display: flex; gap: 15px; align-items: start;
  }
  .review-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #cbd5e1; flex-shrink: 0; }
  .review-content { flex: 1; min-width: 0; }
  .review-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; }
  .review-text { font-size: 0.85rem; color: #475569; white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 5px; }
  .review-actions { display: flex; flex-direction: column; gap: 5px; min-width: 60px; }
</style>
</head>
<body>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="login-panel" class="container">
    <div class="card login-card">
      <h2 style="text-align:center; border:none;">ğŸ”’ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="input-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="login-email" placeholder="admin@example.com">
      </div>
      <div class="input-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="login-pass" placeholder="Password">
      </div>
      <button class="btn btn-primary" onclick="loginEmail()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div style="margin: 20px 0; font-size: 0.8rem; color: #94a3b8;">ã¾ãŸã¯</div>
      <button class="btn btn-google" onclick="loginGoogle()">
        <i class="fab fa-google"></i> Googleã§ãƒ­ã‚°ã‚¤ãƒ³
      </button>
    </div>
  </div>

  <!-- ç®¡ç†ç”»é¢ -->
  <div id="admin-panel" class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 style="margin:0; font-size:1.5rem;">Proç®¡ç†ç”»é¢</h1>
        <button onclick="logout()" class="btn btn-remove" style="width:auto; margin:0; background:#94a3b8;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    
    <!-- 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç† -->
    <div class="card">
      <h2>ğŸ“Š è²©å£²ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š</h2>
      <div class="form-grid">
        <div class="input-group">
          <label>ç¾åœ¨ã®ä¾¡æ ¼ (å††)</label>
          <input type="number" id="current-price" placeholder="ä¾‹: 5000">
        </div>
        <div class="input-group">
          <label>æ¬¡ã®ä¾¡æ ¼ (å††)</label>
          <input type="number" id="next-price" placeholder="ä¾‹: 6000">
        </div>
        <div class="input-group">
          <label>æ®‹ã‚Šäººæ•° (å)</label>
          <input type="number" id="remaining" placeholder="ä¾‹: 10">
        </div>
      </div>
      
      <div class="input-group" style="margin-top: 20px; border-top: 1px dashed #e2e8f0; padding-top: 20px;">
        <label>ğŸ å®Œå£²å±¥æ­´ (éšæ®µã‚°ãƒ©ãƒ•ç”¨)</label>
        <div class="history-inputs">
            <input type="text" id="hist-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: Î²ç‰ˆ)">
            <input type="text" id="hist-count" placeholder="éƒ¨æ•° (ä¾‹: 10éƒ¨)">
            <input type="number" id="hist-price" placeholder="ä¾¡æ ¼ (ä¾‹: 5000)">
            <input type="text" id="hist-date" placeholder="æ—¥æ™‚ (ä¾‹: 2026/02/01)">
        </div>
        <button class="btn" style="background:#0f172a;" onclick="addHistory()">å±¥æ­´ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        <ul id="history-list" style="margin-top: 15px;"></ul>
      </div>

      <button class="btn btn-primary" onclick="saveStatus()" style="margin-top: 20px;">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <!-- 2. å£ã‚³ãƒŸç®¡ç† -->
    <div class="card">
      <h2>ğŸ’¬ å£ã‚³ãƒŸç®¡ç†</h2>
      
      <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:20px;">
          <h3 style="margin-top:0; color:#0369a1; font-size:0.9rem; font-weight:bold;">
              <span id="review-form-title">æ–°è¦è¿½åŠ </span>
          </h3>
          <div class="input-group">
            <label>åå‰ (ä»»æ„)</label>
            <input type="text" id="r-name" placeholder="@username">
          </div>
          <div class="input-group">
            <label>ç”»åƒURL (ä»»æ„)</label>
            <input type="text" id="r-img" placeholder="https://...">
            <input type="file" id="r-file" accept="image/*" style="margin-top:5px;">
          </div>
          <div class="input-group">
            <label>å†…å®¹</label>
            <textarea id="r-content" rows="4" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; font-size:1rem;" placeholder="å£ã‚³ãƒŸå†…å®¹..."></textarea>
          </div>
          <div class="input-group">
            <label>SNSãƒªãƒ³ã‚¯ (ä»»æ„)</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <input type="text" id="r-x" placeholder="X (Twitter)">
              <input type="text" id="r-ig" placeholder="Instagram">
              <input type="text" id="r-yt" placeholder="YouTube">
              <input type="text" id="r-tik" placeholder="TikTok">
            </div>
          </div>
          
          <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" id="btn-save-review" onclick="saveReview()">è¿½åŠ ã™ã‚‹</button>
            <button class="btn btn-cancel" id="btn-cancel-review" onclick="resetReviewForm()" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
      </div>

      <h3>ç™»éŒ²æ¸ˆã¿å£ã‚³ãƒŸä¸€è¦§</h3>
      <ul id="review-list" class="review-list">
          <li style="text-align:center; color:#94a3b8; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</li>
      </ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, orderBy, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
    import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBy8hBH5DNX8GsVvnOfjmyyamc9nIPIR44",
      authDomain: "manage26-price.firebaseapp.com",
      projectId: "manage26-price",
      storageBucket: "manage26-price.firebasestorage.app",
      messagingSenderId: "405218108343",
      appId: "1:405218108343:web:3c91b61adac9e9e07ffe32",
      measurementId: "G-CDWBHCM00C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    let historyData = [];
    let editingReviewId = null;

    onAuthStateChanged(auth, (user) => {
        const loginPanel = document.getElementById('login-panel');
        const adminPanel = document.getElementById('admin-panel');
        if (user) {
            loginPanel.style.display = 'none';
            adminPanel.style.display = 'block';
            loadData();
            loadReviews();
        } else {
            loginPanel.style.display = 'flex';
            adminPanel.style.display = 'none';
        }
    });

    window.loginEmail = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        if(!email || !pass) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
        try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + e.message); }
    };
    window.loginGoogle = async () => {
        try { await signInWithPopup(auth, googleProvider); } catch (e) { alert("Googleãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + e.message); }
    };
    window.logout = () => signOut(auth);

    async function loadData() {
      try {
        const snap = await getDoc(doc(db, "site_config", "status"));
        if (snap.exists()) {
          const d = snap.data();
          document.getElementById('current-price').value = d.current_price || "";
          document.getElementById('next-price').value = d.next_price || "";
          document.getElementById('remaining').value = d.remaining || "";
          if (d.sold_out_history) {
              historyData = d.sold_out_history.map(item => {
                  if (typeof item !== 'object') return { price: item, date: '', title: 'é™å®šè²©å£²', count: '-' };
                  return item;
              });
              renderHistory();
          }
        }
      } catch (e) { console.error("Load Data Error:", e); }
    }

    // å£ã‚³ãƒŸä¸€è¦§ãƒ­ãƒ¼ãƒ‰ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚½ãƒ¼ãƒˆã§å…¨ä»¶è¡¨ç¤º)
    function loadReviews() {
        // orderByã‚’å¤–ã—ã¦å…¨ä»¶å–å¾—ã—ã€JSã§ã‚½ãƒ¼ãƒˆã™ã‚‹ï¼ˆcreatedAtãŒãªã„å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚‚è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
        onSnapshot(collection(db, "testimonials"), (snapshot) => {
            const list = document.getElementById('review-list');
            list.innerHTML = "";
            
            if(snapshot.empty) {
                list.innerHTML = "<li style='text-align:center; padding:20px; color:#94a3b8;'>ã¾ã å£ã‚³ãƒŸãŒã‚ã‚Šã¾ã›ã‚“</li>";
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—åŒ–ã—ã¦ã‚½ãƒ¼ãƒˆ
            let docs = [];
            snapshot.forEach(d => docs.push({ id: d.id, ...d.data() }));
            
            // ä½œæˆæ—¥é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆã€‚ä½œæˆæ—¥ãŒãªã„å ´åˆã¯æœ€å¾Œã«ã€‚
            docs.sort((a, b) => {
                const ta = a.createdAt ? a.createdAt.seconds : 0;
                const tb = b.createdAt ? b.createdAt.seconds : 0;
                return tb - ta;
            });

            docs.forEach((data) => {
                const safeName = (data.name || "åç„¡ã—").replace(/</g, "&lt;");
                const safeContent = (data.content || "").replace(/</g, "&lt;");
                const imgUrl = data.image_url || "";
                
                // ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONæ–‡å­—åˆ—åŒ–ï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
                const jsonStr = JSON.stringify(data).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                const item = document.createElement('li');
                item.className = 'review-item';
                item.innerHTML = `
                    <img src="${imgUrl}" class="review-img" onerror="this.style.display='none'">
                    <div class="review-content">
                        <span class="review-name">${safeName}</span>
                        <div class="review-text">${safeContent}</div>
                    </div>
                    <div class="review-actions">
                        <button class="btn-edit" onclick='editReview("${data.id}", ${jsonStr})'>ç·¨é›†</button>
                        <button class="btn-remove" onclick='deleteReview("${data.id}")'>å‰Šé™¤</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }, (error) => {
            console.error("Reviews Error:", error);
            document.getElementById('review-list').innerHTML = "<li style='color:red;'>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + error.message + "</li>";
        });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’ç™»éŒ²
    window.editReview = (id, data) => {
        editingReviewId = id;
        document.getElementById('review-form-title').innerText = "å£ã‚³ãƒŸã‚’ç·¨é›†";
        document.getElementById('btn-save-review').innerText = "æ›´æ–°ã™ã‚‹";
        document.getElementById('btn-cancel-review').style.display = "inline-block";

        document.getElementById('r-name').value = data.name || "";
        document.getElementById('r-img').value = data.image_url || "";
        document.getElementById('r-content').value = data.content || "";
        document.getElementById('r-x').value = data.link_x || "";
        document.getElementById('r-ig').value = data.link_ig || "";
        document.getElementById('r-yt').value = data.link_yt || "";
        document.getElementById('r-tik').value = data.link_tik || "";
        
        document.getElementById('r-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    window.resetReviewForm = () => {
        editingReviewId = null;
        document.getElementById('review-form-title').innerText = "æ–°è¦è¿½åŠ ";
        document.getElementById('btn-save-review').innerText = "è¿½åŠ ã™ã‚‹";
        document.getElementById('btn-cancel-review').style.display = "none";
        
        document.getElementById('r-name').value = "";
        document.getElementById('r-img').value = "";
        document.getElementById('r-file').value = "";
        document.getElementById('r-content').value = "";
        document.getElementById('r-x').value = "";
        document.getElementById('r-ig').value = "";
        document.getElementById('r-yt').value = "";
        document.getElementById('r-tik').value = "";
    };

    window.saveReview = async () => {
        if (!auth.currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

        const rName = document.getElementById('r-name').value;
        const rContent = document.getElementById('r-content').value;
        const file = document.getElementById('r-file').files[0];
        let rImg = document.getElementById('r-img').value;

        if (!rContent) return alert("å£ã‚³ãƒŸå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        const btn = document.getElementById('btn-save-review');
        btn.innerText = "é€ä¿¡ä¸­...";
        btn.disabled = true;

        try {
            if (file) {
              const storageRef = ref(storage, 'reviews/' + Date.now() + "_" + file.name);
              await uploadBytes(storageRef, file);
              rImg = await getDownloadURL(storageRef);
            }

            const docData = {
              name: rName || "åç„¡ã—ã•ã‚“",
              image_url: rImg,
              content: rContent,
              link_x: document.getElementById('r-x').value,
              link_ig: document.getElementById('r-ig').value,
              link_yt: document.getElementById('r-yt').value,
              link_tik: document.getElementById('r-tik').value,
            };
            
            // æ–°è¦ä½œæˆæ™‚ã®ã¿ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
            if (!editingReviewId) {
                docData.createdAt = serverTimestamp();
            }

            if (editingReviewId) {
                await updateDoc(doc(db, "testimonials", editingReviewId), docData);
                alert("å£ã‚³ãƒŸã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
            } else {
                await addDoc(collection(db, "testimonials"), docData);
                alert("å£ã‚³ãƒŸã‚’è¿½åŠ ã—ã¾ã—ãŸï¼");
            }
            resetReviewForm();
        } catch(e) {
            console.error(e);
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            btn.innerText = editingReviewId ? "æ›´æ–°ã™ã‚‹" : "è¿½åŠ ã™ã‚‹";
            btn.disabled = false;
        }
    };

    window.deleteReview = async (id) => {
        if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try { await deleteDoc(doc(db, "testimonials", id)); } 
        catch(e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message); }
    };

    window.addHistory = () => {
        const title = document.getElementById('hist-title').value || "é™å®šè²©å£²";
        const count = document.getElementById('hist-count').value || "-";
        const price = Number(document.getElementById('hist-price').value);
        const date = document.getElementById('hist-date').value;
        if(!price) return alert("ä¾¡æ ¼ã¯å¿…é ˆã§ã™");
        historyData.push({ title, count, price, date });
        renderHistory();
        document.getElementById('hist-title').value = '';
        document.getElementById('hist-count').value = '';
        document.getElementById('hist-price').value = '';
        document.getElementById('hist-date').value = '';
    };

    window.removeHistory = (index) => {
        historyData.splice(index, 1);
        renderHistory();
    };

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = "";
        historyData.forEach((item, index) => {
            list.innerHTML += `
                <li class="history-item">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <strong>${item.title} (${item.count})</strong>
                        <span style="font-size:0.8rem; color:#64748b;">Â¥${item.price.toLocaleString()} | ${item.date}</span>
                    </div>
                    <button class="btn-remove" onclick="removeHistory(${index})">å‰Šé™¤</button>
                </li>
            `;
        });
    }

    window.saveStatus = async () => {
      if (!auth.currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
      try {
        await setDoc(doc(db, "site_config", "status"), {
          current_price: Number(document.getElementById('current-price').value),
          next_price: Number(document.getElementById('next-price').value),
          remaining: Number(document.getElementById('remaining').value),
          sold_out_history: historyData
        });
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
      } catch(e) { alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message); }
    };
  </script>
</body>
</html>